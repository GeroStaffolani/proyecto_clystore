{% extends 'base.html' %}

{% block title %}Registrar Venta - {{ phone.model }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>Registrar Venta
                </h4>
            </div>
            <div class="card-body">
                <!-- Información del celular -->
                <div class="alert alert-info">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="alert-heading">{{ phone.model }}</h5>
                            <p class="mb-1"><strong>IMEI:</strong> {{ phone.imei }}</p>
                            <p class="mb-1"><strong>Condición:</strong> {{ phone.get_condition_display }}</p>
                            {% if phone.color %}<p class="mb-1"><strong>Color:</strong> {{ phone.color }}</p>{% endif %}
                            {% if phone.storage_capacity %}<p class="mb-0"><strong>Almacenamiento:</strong> {{ phone.storage_capacity }}</p>{% endif %}
                        </div>
                        <div class="col-md-4 text-end">
                            <h4 class="text-primary">${{ phone.price }}</h4>
                            <small class="text-muted">Precio sugerido</small>
                        </div>
                    </div>
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Información del cliente -->
                        <div class="col-md-6">
                            <h5 class="mb-3">Información del Cliente</h5>
                            
                            <div class="mb-3">
                                <label for="{{ form.customer.id_for_label }}" class="form-label">{{ form.customer.label }}</label>
                                <div class="customer-search-container position-relative">
                                    <input type="text" id="customer-search-sale" class="form-control" placeholder="Buscar cliente por nombre, teléfono, email o DNI..." autocomplete="off">
                                    <div id="customer-dropdown-sale" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                                    {{ form.customer }}
                                    <div id="selected-customer-info-sale" class="small text-muted mt-1" style="display: none;"></div>
                                </div>
                                {% if form.customer.errors %}
                                    <div class="text-danger small">{{ form.customer.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <a href="{% url 'add_customer' %}?next={{ request.path }}" target="_blank">Agregar nuevo cliente</a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información de la venta -->
                        <div class="col-md-6">
                            <h5 class="mb-3">Información de la Venta</h5>
                            
                            <div class="mb-3">
                                <label for="{{ form.sale_price.id_for_label }}" class="form-label">{{ form.sale_price.label }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">USD</span>
                                    {{ form.sale_price }}
                                </div>
                                {% if form.sale_price.errors %}
                                    <div class="text-danger small">{{ form.sale_price.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.payment_method.id_for_label }}" class="form-label">{{ form.payment_method.label }}</label>
                                {{ form.payment_method }}
                                {% if form.payment_method.errors %}
                                    <div class="text-danger small">{{ form.payment_method.errors }}</div>
                                {% endif %}
                                
                                <!-- Sección de detalles de tarjeta -->
                                <div id="card-detail-section" style="display:none;" class="mt-3 p-3 border rounded bg-light">
                                    <h6 class="mb-3">Detalles de Pago con Tarjeta</h6>
                                    {% if card_form %}
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="id_tarjeta" class="form-label">{{ card_form.tarjeta.label }}</label>
                                                {{ card_form.tarjeta }}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="id_cuotas" class="form-label">{{ card_form.cuotas.label }}</label>
                                                {{ card_form.cuotas }}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="id_cotizacion_dolar" class="form-label">{{ card_form.cotizacion_dolar.label }}</label>
                                                {{ card_form.cotizacion_dolar }}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="id_monto_base" class="form-label">{{ card_form.monto_base.label }}</label>
                                                {{ card_form.monto_base }}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="id_monto_total" class="form-label">{{ card_form.monto_total.label }}</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    {{ card_form.monto_total }}
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="id_valor_cuota" class="form-label">{{ card_form.valor_cuota.label }}</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    {{ card_form.valor_cuota }}
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="id_monto_usd" class="form-label">{{ card_form.monto_usd.label }}</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">USD</span>
                                                    {{ card_form.monto_usd }}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div id="mixed-builder" style="display:none;" class="mt-3">
                                    <h6 class="mb-2">Componentes del Pago</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle" id="mixed-table">
                                            <thead>
                                                <tr>
                                                    <th style="width:18%">Tipo</th>
                                                    <th style="width:15%">Monto</th>
                                                    <th style="width:15%">Moneda</th>
                                                    <th style="width:15%">Cotización</th>
                                                    <th style="width:15%">Cuotas</th>
                                                    <th style="width:15%">Tarjeta</th>
                                                    <th style="width:7%"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="mixed-rows"></tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-component-btn">
                                        <i class="fas fa-plus me-1"></i>Agregar componente
                                    </button>
                                    <input type="hidden" name="payment_breakdown_json" id="payment_breakdown_json">
                                    <div class="mt-3 small text-muted" id="mixed-summary"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.is_picked_up }}
                                    <label class="form-check-label" for="{{ form.is_picked_up.id_for_label }}">
                                        {{ form.is_picked_up.label }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parte de pago -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <div class="form-check">
                                {{ form.has_trade_in }}
                                <label class="form-check-label" for="{{ form.has_trade_in.id_for_label }}">
                                    <strong>{{ form.has_trade_in.label }}</strong>
                                </label>
                            </div>
                        </div>
                        <div class="card-body" id="trade-in-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.trade_in_model.id_for_label }}" class="form-label">{{ form.trade_in_model.label }}</label>
                                    {{ form.trade_in_model }}
                                    {% if form.trade_in_model.errors %}
                                        <div class="text-danger small">{{ form.trade_in_model.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.trade_in_value.id_for_label }}" class="form-label">{{ form.trade_in_value.label }}</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.trade_in_value }}
                                    </div>
                                    {% if form.trade_in_value.errors %}
                                        <div class="text-danger small">{{ form.trade_in_value.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notas -->
                    <div class="mb-3 mt-4">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="text-danger small">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'phone_detail' phone.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-shopping-cart me-2"></i>Registrar Venta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentMethodSelect = document.getElementById('{{ form.payment_method.id_for_label }}');
    const cardDetailSection = document.getElementById('card-detail-section');
    const mixedBuilder = document.getElementById('mixed-builder');
    const mixedRows = document.getElementById('mixed-rows');
    const addComponentBtn = document.getElementById('add-component-btn');
    const paymentBreakdownInput = document.getElementById('payment_breakdown_json');
    const mixedSummary = document.getElementById('mixed-summary');

    const PAYMENT_TYPES = [
        {value:'cash_ars', label:'Efectivo ARS', currency:'ARS'},
        {value:'cash_usd', label:'Efectivo USD', currency:'USD'},
        {value:'card', label:'Tarjeta', currency:'ARS'},
        {value:'transfer', label:'Transferencia', currency:'ARS'},
    ];

    function createSelectType() {
        const sel = document.createElement('select');
        sel.className = 'form-select form-select-sm';
        PAYMENT_TYPES.forEach(t => { const o=document.createElement('option'); o.value=t.value; o.textContent=t.label; sel.appendChild(o); });
        return sel;
    }
    function createInput(type, placeholder, step='0.01') {
        const inp = document.createElement('input'); inp.type=type; inp.placeholder=placeholder; inp.className='form-control form-control-sm'; if(type==='number') inp.step=step; return inp;
    }
    function addComponentRow(prefill) {
        const tr=document.createElement('tr');
        const tdType=document.createElement('td'); const tdAmount=document.createElement('td'); const tdCurrency=document.createElement('td'); const tdRate=document.createElement('td'); const tdInstall=document.createElement('td'); const tdCard=document.createElement('td'); const tdActions=document.createElement('td');
        const selType=createSelectType();
        const inpAmount=createInput('number','Monto');
        const selCurrency=document.createElement('select'); selCurrency.className='form-select form-select-sm'; ['ARS','USD'].forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;selCurrency.appendChild(o);});
        const inpRate=createInput('number','Cotización'); inpRate.step='0.01';
        const inpInstall=createInput('number','Cuotas','1');
        const inpCard=createInput('text','Tarjeta');
        const btnDel=document.createElement('button'); btnDel.type='button'; btnDel.className='btn btn-outline-danger btn-sm'; btnDel.innerHTML='<i class="fas fa-trash"></i>';
        btnDel.addEventListener('click', ()=>{tr.remove(); serializeMixed();});
        selType.addEventListener('change', ()=>adjustRow(selType, selCurrency, inpRate, inpInstall, inpCard));
        [inpAmount, selCurrency, inpRate, inpInstall, inpCard].forEach(el=>el.addEventListener('input', serializeMixed));
        tdType.appendChild(selType); tdAmount.appendChild(inpAmount); tdCurrency.appendChild(selCurrency); tdRate.appendChild(inpRate); tdInstall.appendChild(inpInstall); tdCard.appendChild(inpCard); tdActions.appendChild(btnDel);
        [tdType,tdAmount,tdCurrency,tdRate,tdInstall,tdCard,tdActions].forEach(td=>tr.appendChild(td));
        mixedRows.appendChild(tr);
        if(prefill){ selType.value=prefill.tipo||'cash_ars'; inpAmount.value=prefill.monto||''; selCurrency.value=prefill.moneda||(prefill.tipo==='cash_usd'?'USD':'ARS'); inpRate.value=prefill.cotizacion||''; inpInstall.value=prefill.cuotas||''; inpCard.value=prefill.tarjeta||''; }
        adjustRow(selType, selCurrency, inpRate, inpInstall, inpCard); serializeMixed();
    }
    function adjustRow(selType, selCurrency, inpRate, inpInstall, inpCard) {
        const type=selType.value;
        if(type==='cash_usd'){
            // For USD cash: fixed USD, no cotización
            selCurrency.value='USD';
            selCurrency.disabled=true;
            inpRate.disabled=true; inpRate.value='';
        } else {
            // Allow currency change
            selCurrency.disabled=false;
            if(selCurrency.value==='USD') {
                // If user picks USD manually for something that's not cash_usd, still no rate
                inpRate.disabled=true; inpRate.value='';
            } else {
                // ARS paths (cash_ars, transfer, card) -> enable cotización
                inpRate.disabled=false;
            }
        }
        const isCard = type==='card'; inpInstall.disabled=!isCard; inpCard.disabled=!isCard; if(!isCard){inpInstall.value=''; inpCard.value='';}
    }
    function serializeMixed() {
        const rows=Array.from(mixedRows.querySelectorAll('tr'));
        const data=rows.map(r=>{ const [selType, inpAmount, selCurrency, inpRate, inpInstall, inpCard]=r.querySelectorAll('select, input'); return {tipo:selType.value, monto:inpAmount.value?parseFloat(inpAmount.value):null, moneda:selCurrency.value, cotizacion:inpRate.value?parseFloat(inpRate.value):null, cuotas:inpInstall.value?parseInt(inpInstall.value):null, tarjeta:inpCard.value||null}; });
        paymentBreakdownInput.value=JSON.stringify(data); updateSummary(data);
    }
    function updateSummary(data){ if(!data.length){mixedSummary.textContent=''; return;} let totalUSD=0; data.forEach(d=>{ if(!d.monto) return; if(d.moneda==='USD') totalUSD+=d.monto; else if(d.moneda==='ARS'){ if(d.cotizacion) totalUSD+= d.monto/d.cotizacion; }}); mixedSummary.innerHTML=`Total estimado USD: <strong>${totalUSD.toFixed(2)}</strong>`; }
    if(addComponentBtn){ addComponentBtn.addEventListener('click', ()=>addComponentRow()); }
    function togglePaymentSections(){
        const method = paymentMethodSelect.value;
        if(method==='mixed') { mixedBuilder.style.display='block'; if(!mixedRows.querySelector('tr')) addComponentRow(); }
        else { mixedBuilder.style.display='none'; }
        if(method==='card'){ cardDetailSection && (cardDetailSection.style.display='block'); }
        else { cardDetailSection && (cardDetailSection.style.display='none'); }
    }
    paymentMethodSelect.addEventListener('change', togglePaymentSections);
    togglePaymentSections();

    // Card payment calculations
    const cuotasSelect = document.getElementById('id_cuotas');
    const cotizacionInput = document.getElementById('id_cotizacion_dolar');
    const montoBaseInput = document.getElementById('id_monto_base');
    const montoTotalInput = document.getElementById('id_monto_total');
    const valorCuotaInput = document.getElementById('id_valor_cuota');
    const montoUsdInput = document.getElementById('id_monto_usd');
    
    function calculateCardPayment() {
        if (!montoBaseInput || !cuotasSelect || !cotizacionInput || !montoTotalInput || !montoUsdInput) {
            return;
        }
        
        const montoBaseUSD = parseFloat(montoBaseInput.value) || 0;
        const cuotas = cuotasSelect.value;
        const cotizacion = parseFloat(cotizacionInput.value) || 0;
        const numCuotas = parseInt(cuotas) || 1;
        
        if (cotizacion === 0) {
            montoTotalInput.value = '';
            if (valorCuotaInput) valorCuotaInput.value = '';
            return;
        }
        
        let interes = 0;
        if (cuotas === '3') {
            interes = 0.15; // 15%
        } else if (cuotas === '6') {
            interes = 0.22; // 22%
        }
        
        // Convertir USD a pesos primero
        const montoEnPesos = montoBaseUSD * cotizacion;
        
        // Aplicar interés al monto en pesos
        const montoTotal = montoEnPesos * (1 + interes);
        
        // Calcular valor de cada cuota
        const valorCuota = montoTotal / numCuotas;
        
        montoTotalInput.value = montoTotal.toFixed(2);
        if (valorCuotaInput) valorCuotaInput.value = valorCuota.toFixed(2);
        montoUsdInput.value = montoBaseUSD.toFixed(2);
    }
    
    if (cuotasSelect) {
        cuotasSelect.addEventListener('change', calculateCardPayment);
    }
    if (cotizacionInput) {
        cotizacionInput.addEventListener('input', calculateCardPayment);
    }
    
    // Calculate initial values
    calculateCardPayment();

    // Parte de pago toggle
    const tradeInCheckbox = document.getElementById('{{ form.has_trade_in.id_for_label }}');
    const tradeInSection = document.getElementById('trade-in-section');
    if(tradeInCheckbox){
        tradeInCheckbox.addEventListener('change', ()=>{ tradeInSection.style.display = tradeInCheckbox.checked ? 'block':'none'; });
        if(tradeInCheckbox.checked) tradeInSection.style.display='block';
    }

    // Customer search functionality for sales
    const customerSearchSale = document.getElementById('customer-search-sale');
    const customerDropdownSale = document.getElementById('customer-dropdown-sale');
    const customerFieldSale = document.getElementById('id_customer');
    const selectedCustomerInfoSale = document.getElementById('selected-customer-info-sale');
    let searchTimeoutSale;

    // Ocultar el select original
    if (customerFieldSale) {
        customerFieldSale.style.display = 'none';
    }

    // Configurar el valor inicial si hay uno seleccionado
    if (customerFieldSale && customerFieldSale.value) {
        const selectedOption = customerFieldSale.querySelector(`option[value="${customerFieldSale.value}"]`);
        if (selectedOption) {
            customerSearchSale.value = selectedOption.textContent.trim();
            selectedCustomerInfoSale.textContent = `Cliente seleccionado: ${selectedOption.textContent.trim()}`;
            selectedCustomerInfoSale.style.display = 'block';
        }
    }

    customerSearchSale.addEventListener('input', function() {
        clearTimeout(searchTimeoutSale);
        const query = this.value.trim();
        
        if (query.length < 2) {
            customerDropdownSale.style.display = 'none';
            return;
        }

        searchTimeoutSale = setTimeout(() => {
            fetch(`{% url 'search_customers' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    customerDropdownSale.innerHTML = '';
                    
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(customer => {
                            const item = document.createElement('a');
                            item.className = 'dropdown-item';
                            item.href = '#';
                            item.innerHTML = `
                                <div>
                                    <strong>${customer.name}</strong>
                                    <br>
                                    <small class="text-muted">
                                        ${customer.phone ? 'Tel: ' + customer.phone : ''} 
                                        ${customer.email ? 'Email: ' + customer.email : ''}
                                        ${customer.dni ? 'DNI: ' + customer.dni : ''}
                                    </small>
                                </div>
                            `;
                            
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                customerSearchSale.value = customer.name;
                                customerFieldSale.value = customer.id;
                                selectedCustomerInfoSale.textContent = `Cliente seleccionado: ${customer.display_text}`;
                                selectedCustomerInfoSale.style.display = 'block';
                                customerDropdownSale.style.display = 'none';
                            });
                            
                            customerDropdownSale.appendChild(item);
                        });
                        customerDropdownSale.style.display = 'block';
                    } else {
                        customerDropdownSale.innerHTML = '<div class="dropdown-item-text text-muted">No se encontraron clientes</div>';
                        customerDropdownSale.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error searching customers:', error);
                    customerDropdownSale.style.display = 'none';
                });
        }, 300);
    });

    // Cerrar dropdown cuando se hace click fuera
    document.addEventListener('click', function(e) {
        if (!customerSearchSale.contains(e.target) && !customerDropdownSale.contains(e.target)) {
            customerDropdownSale.style.display = 'none';
        }
    });

    // Limpiar selección cuando se borra el campo
    customerSearchSale.addEventListener('input', function() {
        if (this.value.trim() === '') {
            customerFieldSale.value = '';
            selectedCustomerInfoSale.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
